@model CommentViewModel

@using ArtCosplay.Data
@using ArtCosplay.Data.DB
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager
@inject AppDbContext DbContext

@{
    ViewData["Title"] = "Обсуждение";

    int discussionId = Convert.ToInt32(ViewData["DiscussionId"]);
    int page = Convert.ToInt32(ViewData["Page"] ?? 1);

    Discussion? discussion = DbContext.Discussions
        .Include(d => d.Author)
        .Include(d => d.Comments)
        .Include(d => d.Likes)
        .FirstOrDefault(i => i.DiscussionId == discussionId);

    List<Comment> comments = DbContext.Comments
        .Include(d => d.Likes)
        .Include(d => d.User)
        .Where(i => i.DiscussionId == discussionId)
        .OrderByDescending(x => x.CommentId)
        .ToList();


    if (page <= 0)
        page = 1;
    else if (page > discussion.Comments.Count / 5)
        page = discussion.Comments.Count / 5 + 1;
}

<div class="discussion-container">
    <div class="discussion-content">
        <div class="discussion-header">
            <img src="@discussion.Author.AvatarUrl" alt="Аватар" class="discussion-avatar">
            <div class="discussion-user-info">
                <div class="discussion-user">@discussion.Author.UserName</div>
                <div class="discussion-time">@discussion.CreatedAt.ToString()</div>
            </div>
        </div>

        <h1 class="discussion-title">@discussion.Title</h1>

        <p class="discussion-text">@discussion.Content</p>

        @*         <div class="discussion-tags">
            <span class="discussion-tag">#naruto</span>
            <span class="discussion-tag">#sakura</span>
            <span class="discussion-tag">#digitalart</span>
            <span class="discussion-tag">#fanart</span>
            <span class="discussion-tag">#anime</span>
        </div> *@

        <div class="discussion-actions">
            <div class="discussion-action">
                <i class="far fa-thumbs-up"></i>
                <span>@discussion.Likes.Count</span>
            </div>
            <div class="discussion-action">
                <i class="far fa-comment"></i>
                <span>@discussion.Comments.Count комментария</span>
            </div>
        </div>
    </div>

    <div class="comments-section">
        <h2 class="comments-title">Комментарии (@discussion.Comments.Count)</h2>

        <div class="comment-form">
            <input type="hidden" id="discussion-id" value="@discussionId" />
            <textarea class="comment-textarea" placeholder="Напишите ваш комментарий..." id="comment-textarea" maxlength="300" style="
                display: block;
                width: 100%;
                border-radius: 12px;
                margin-bottom: 15px;
                height: 80px;
                border: none;
                outline: none;
                box-shadow: 1px 2px 5px rgba(0, 0, 0, 0.1);
                padding: 5px;
            "
            ></textarea>
            <button type="submit" class="comment-submit" style="width: 100%; margin-bottom: 10px;" id="comment-send">Отправить</button>
        </div>

        <div class="comments-pagination-info">
            Показаны комментарии 1-5 из @discussion.Comments.Count
        </div>

        <div class="comment-list">
            @if (@discussion.Comments.Count != 0)
            {
                @foreach (var comment in comments.Chunk(5).ElementAt(page - 1))
                {
                    <div class="comment-item">
                        <img src="@comment.User.AvatarUrl" alt="Аватар" class="comment-avatar">
                        <div class="comment-content">
                            <div class="comment-header">
                                <span class="comment-user">@@@comment.User.UserName</span>
                                <span class="comment-time">@comment.CreatedAt</span>
                            </div>
                            <p class="comment-text">@comment.Text</p>
                            <div class="comment-actions">
                                <div class="comment-action">
                                    <i class="far fa-thumbs-up"></i>
                                    <span>@comment.Likes.Count</span>
                                </div>
                                <div class="comment-action">
                                    <i class="fas fa-reply"></i>
                                    <span>Ответить</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                <div class="pagination">
                    @for (int i = page - 2 <= 0 ? 1 : page - 2; i <= discussion.Comments.Count / 5 + 1; ++i)
                    {
                        <a href="#" class="page-number@(i == page ? " active" : string.Empty)">@i</a>
                    }
                    @if(discussion.Comments.Count / 5.0 > 1.0)
                    {
                        <a href="#" class="page-number">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    }
                </div>
            }
            else
            {
                <span>Нет ещё комментариев!</span>
            }
        </div>
    </div>
</div>

<script>
    function addComment()
    {
        contentBox = document.getElementById('comment-textarea');

        fetch('/User/DiscussionComment', {
            method : 'POST',
            headers: {
                'Content-Type': 'application/json;charset=utf-8'
            },
            body: JSON.stringify({
                Id: document.getElementById('discussion-id').value,
                Content : contentBox.value
            })
        })
        .then(response => response.json())
        .then(json => {
            if (json['status'] == 'success') {
                alert('NICE');
            }
        });
    }

    var button = document.getElementById('comment-send');
    button.onclick = addComment;
</script>