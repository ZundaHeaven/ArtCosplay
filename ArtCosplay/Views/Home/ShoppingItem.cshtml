@using ArtCosplay.Data
@using ArtCosplay.Data.DB
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject UserManager<User> UserManager
@inject AppDbContext DbContext

@{
    int productId = Convert.ToInt32(ViewData["Id"]);
    var item = DbContext.Products
        .Include(x => x.Seller)
        .First(x => x.ProductId == productId);

    var user = await UserManager.GetUserAsync(User);

    IEnumerable<Message> messages = new List<Message>();
    if (user != null)
    {
        var chat = DbContext.Chats
            .FirstOrDefault(x => x.SellerId == item.SellerId && x.BuyerId == user!.Id);

        if (chat != null)
            messages = DbContext.Messages.Where(x => x.ChatId == chat.ChatId);
    }
}

<div class="product-container">
    <div class="product-section">
        <h1 class="product-title">@item.Title</h1>
        <div class="product-price">@item.Price р.</div>

        <div class="product-gallery">
            <img src="@item.ImageUrl" alt="Предмет" class="product-main-image">
        </div>

        <div class="product-details">
            <h2 class="product-details-title">Описание товара</h2>
            <p class="product-description">
                @item.Description
            </p>

            <div class="product-info">
                <div class="info-label">Город:</div>
                <div class="info-value">@item.City</div>
            </div>
        </div>
    </div>

    @if (user != null)
    {
        if(user.Id != item.SellerId)
        {
            <aside class="chat-section">
                <h2 class="chat-title">Чат с продавцом</h2>

                <div class="seller-info">
                    <img src="@item.Seller.AvatarUrl" alt="Продавец" class="seller-avatar">
                    <div>
                        <div class="seller-name">@item.Seller.UserName</div>
                        @*                     <div class="seller-rating">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                        <span style="color: #777; margin-left: 5px;">4.7 (23 отзыва)</span>
                    </div> 
                    <div class="seller-location">Москва · На сайте 2 года</div>*@
                    </div>
                </div>

                <div class="chat-messages">
                    @foreach (var message in messages)
                    {
                        <div class="message @(message.SenderId == item.SellerId ? "seller-message" : "user-message")">
                            @message.Content
                            <div class="message-time">@message.SentAt</div>
                        </div>
                    }
                </div>
                <div class="chat-input">
                    <input type="text" class="chat-input-field" placeholder="Напишите сообщение...">
                    <button class="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </aside>
        }
    }
</div>
